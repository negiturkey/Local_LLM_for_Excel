<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM for Excel</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="ms-font-m">
    <header class="header">
        <h1 class="title">Local LLM for Excel</h1>
        <div class="status-indicator" id="status-indicator">
            <span class="status-dot"></span>
            <span id="status-text">Checking...</span>
        </div>
    </header>

    <main class="container">
        <section class="settings">
            <div class="field">
                <label>Provider:</label>
                <select id="provider-select">
                    <option value="ollama">Ollama (11434)</option>
                    <option value="lmstudio">LM Studio (1234)</option>
                    <option value="gemini">Google Gemini (API)</option>
                </select>
                <input type="password" id="api-key" placeholder="API Key (Gemini)" class="api-key-input"
                    style="display:none; margin-top: 5px; width: 100%;">
            </div>
            <div class="field">
                <label>Model:</label>
                <select id="model-select">
                    <option value="">Loading...</option>
                </select>
                <button id="refresh-models" class="btn-icon">🔄</button>
            </div>
            <div class="field">
                <button id="load-model" class="btn-small">ロード</button>
                <button id="unload-model" class="btn-small">終了(VRAM解放)</button>
                <button id="test-connection" class="btn-small">診断</button>
            </div>
        </section>

        <div id="chat-window" class="chat-window"></div>

        <section class="interaction-area">
            <label class="checkbox-container">
                <input type="checkbox" id="include-selection" checked>
                選択中のセルのデータをAIに送る
            </label>
            <div id="image-preview-container"
                style="display:none; margin-bottom: 8px; position: relative; border: 1px solid var(--border-color); border-radius: 8px; padding: 4px; background: white;">
                <img id="image-preview" src="" style="max-height: 80px; border-radius: 4px;">
                <button id="remove-image" class="btn-icon"
                    style="position: absolute; top: 0; right: 0; color: red;">×</button>
            </div>
            <!-- Template Selector -->
            <div class="field" style="margin-bottom: 8px;">
                <label>テンプレート:</label>
                <select id="template-select"
                    style="width: 100%; border: 1px solid #ccc; padding: 4px; border-radius: 4px;">
                    <option value="">(選択してください)</option>
                </select>
                <div style="display: flex; gap: 4px; margin-top: 4px;">
                    <button id="save-template-btn" class="btn-small" title="現在の入力をテンプレートとして保存">💾 保存</button>
                    <button id="delete-template-btn" class="btn-small btn-danger" title="選択中のテンプレートを削除" disabled>🗑️
                        削除</button>
                </div>
            </div>

            <textarea id="prompt-input" placeholder="質問を入力..."></textarea>
            <div class="actions-row">
                <input type="file" id="image-input" accept="image/*" style="display:none;">
                <button id="upload-btn" class="btn-secondary" title="画像を添付">📎 画像</button>
                <button id="send-btn" class="btn-primary" style="flex: 2;">送信</button>
                <button id="batch-btn" class="btn-secondary" style="flex: 1; background-color: #6c757d; color: white;"
                    title="行ごとに繰り返し実行">一括実行</button>
                <button id="stop-btn" class="btn-danger" style="flex: 2; display: none;">⏹ 停止</button>
            </div>
            <div class="actions-row">
                <button id="apply-to-cell" class="btn-secondary" disabled>回答をセルに入力</button>
                <button id="clear-chat" class="btn-outline">クリア</button>
            </div>
        </section>
    </main>
    <!-- Save Template Modal -->
    <div id="save-modal" class="modal-overlay"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div class="modal-content"
            style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 300px;">
            <h3>テンプレート保存</h3>
            <div class="field">
                <label>名前:</label>
                <input type="text" id="template-name-input" style="width: 100%; margin-bottom: 10px;">
            </div>
            <div class="field">
                <label>カテゴリ:</label>
                <input type="text" id="template-category-input" value="ユーザー定義"
                    style="width: 100%; margin-bottom: 10px;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancel-save-btn" class="btn-outline">キャンセル</button>
                <button id="confirm-save-btn" class="btn-primary">保存</button>
            </div>
        </div>
    </div>
    <!-- Delete Template Modal -->
    <div id="delete-modal" class="modal-overlay"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div class="modal-content"
            style="background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 300px;">
            <h3>テンプレート削除</h3>
            <p id="delete-message" style="margin-bottom: 20px;">このテンプレートを削除しますか？</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancel-delete-btn" class="btn-outline">キャンセル</button>
                <button id="confirm-delete-btn" class="btn-danger">削除</button>
            </div>
        </div>
    </div>
    <script src="app.js?v=7"></script>
</body>

</html>